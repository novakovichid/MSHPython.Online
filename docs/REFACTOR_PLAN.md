# План полного рефакторинга редактора и runtime

## Контекст

Текущий hotfix закрывает критичный рассинхрон слоёв редактора (курсор/выделение/скролл). Следующий этап - системный рефакторинг архитектуры без регрессий по учебным сценариям.

## Цели

- Упростить и стабилизировать редакторный слой.
- Удалить legacy/дублирующийся код и заархивировать неиспользуемые модули.
- Уменьшить стоимость поддержки (багфиксы, тесты, выпуск релизов).
- Сохранить совместимость UX: модули, консоль, turtle, snapshot/remix, адаптив.

## Инвентаризация и аудит

1. Провести аудит runtime и UI-слоёв:
   - `assets/skulpt-app.js` (основной путь),
   - `assets/app.js` (зеркальный путь),
   - `assets/skulpt-styles.css` и `assets/styles.css`.
2. Построить матрицу использования функций:
   - используется в проде,
   - используется только в тестах,
   - мёртвый код/исторический хвост.
3. Зафиксировать всё дублирование:
   - одинаковые функции с разными версиями,
   - расхождения в константах и селекторах.

## Варианты развития редактора

### Вариант A: оставить custom 2-layer редактор

- Что делаем:
  - модульная декомпозиция текущего редактора (scroll-sync/highlight/selection/line-numbers),
  - жёсткие инварианты в тестах на синхронизацию слоёв.
- Плюсы:
  - минимальный объём миграции,
  - полная совместимость текущего UX.
- Риски:
  - остаётся архитектурная сложность 2-layer,
  - выше вероятность тонких UI-багов при будущих доработках.
- Трудоёмкость: низкая/средняя.

### Вариант B: миграция на CodeMirror 6

- Что делаем:
  - замена custom редактора на CM6 с сохранением существующих команд/горячих клавиш.
- Плюсы:
  - зрелая экосистема, устойчивость к багам каретки/выделения/scroll.
- Риски:
  - миграция интеграций (line highlight, mobile режимы, настройки),
  - потенциальный рост bundle.
- Трудоёмкость: средняя/высокая.

### Вариант C: миграция на Monaco

- Что делаем:
  - переход на Monaco + адаптация UI вокруг него.
- Плюсы:
  - максимально мощный редакторный движок.
- Риски:
  - самый большой bundle и стоимость интеграции,
  - повышенные требования к производительности на слабых устройствах.
- Трудоёмкость: высокая.

## Критерии выбора варианта

- Стабильность каретки/выделения/скролла на длинных текстах.
- Производительность на школьных ноутбуках и мобильных устройствах.
- Размер бандла и скорость загрузки.
- Стоимость миграции и поддерживаемость командой.
- Совместимость со snapshot/remix, turtle, embed-режимом.

## Архивирование и удаление мусора

1. Ввести `docs/LEGACY_INVENTORY.md` с полным списком кандидатов на архив.
2. Для каждого кандидата фиксировать:
   - где используется,
   - чем заменяется,
   - дата удаления.
3. Архивировать модули в `legacy/` только если:
   - есть тесты на новый путь,
   - есть ссылка на commit/релиз с миграцией.
4. Финально удалять архив спустя 2 релизных цикла без откатов, только с подтверждением основного разработчика.

## Роадмап миграции

1. Этап 1 - аудит и карта зависимостей.
2. Этап 2 - выделение редактора в изолированный модульный слой.
3. Этап 3 - пилот выбранного варианта (A/B/C) под feature-flag.
4. Этап 4 - параллельные e2e прогоны старого и нового пути.
5. Этап 5 - переключение по умолчанию и стабилизация.
6. Этап 6 - удаление legacy-кода и актуализация документации.

## Обязательные guardrails

- Ни один шаг не принимается без зелёного набора unit + e2e regression.
- Для каждого изменения редактора сохраняется matrix-проверка Chromium/Firefox/WebKit.
- Любой прирост ошибок `SyntaxError`/line-mapping трактуется как регрессия.
- Все этапы миграции документируются в процессе. Документирование должно позволить любому разработчику или ИИ-агенту подхватить процесс на лету.
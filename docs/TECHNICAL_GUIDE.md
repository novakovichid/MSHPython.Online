# Техническое руководство

## Обзор
МШПайтон.Онлайн — это статическое одностраничное приложение (SPA), которое запускает Python через Skulpt и предоставляет редактор файлов, консоль ввода/вывода и холст для графики Turtle. Основной поток обрабатывает интерфейс, хранилище и отрисовку Turtle. Все данные остаются в браузере пользователя.

## Документация кода
Основные файлы содержат JSDoc комментарии для ключевых функций. Для работы с исходным кодом:
- **[assets/skulpt-app.js](../assets/skulpt-app.js)** — основная логика UI и управление проектами
- **[assets/worker.js](../assets/worker.js)** — Web Worker для выполнения Python кода

Для генерации полной HTML документации выполните:
```bash
npm install --save-dev jsdoc
npx jsdoc -c jsdoc.json
```

Документация будет доступна в `docs/api/` после выполнения.

## Структура каталогов
- `index.html`: Оболочка SPA Skulpt и CSP.
- `assets/skulpt-app.js`: Логика интерфейса и выполнения (роутер, редактор, хранилище, шеринг).
- `assets/skulpt-styles.css`: Стили и верстка интерфейса.
- `assets/worker.js`: Воркер для выполнения Python кода.
- `assets/fflate.esm.js`: Резервный вариант gzip для браузеров без CompressionStream.
- `vendor/skulpt/skulpt-dist-master/`: Среда выполнения Skulpt и стандартная библиотека.
- `docs/`: Документация и руководства.

## Процесс загрузки
1. `index.html` загружает `assets/skulpt-app.js` как модуль.
2. `init()` привязывает обработчики интерфейса, регистрирует сервис-воркер и проверяет поддержку среды (Worker).
3. `ensureRuntimeCompatibility()` инициирует разовую перезагрузку, если требуется COI.
4. Открывается IndexedDB; при блокировке используется резервное хранилище в памяти.
5. Создается и инициализируется Web Worker со Skulpt.

## Роутинг
Используется роутинг на основе хеша (поддерживается GitHub Pages):
- `/#/` : главная страница.
- `/#/p/{projectId}` : редактируемый проект.
- `/#/s/{shareId}?p={payload}` : неизменяемый снимок.
- `/#/embed` : режим встраивания с настройками в строке запроса.

## Модель хранения
База данных IndexedDB: `mshp-ide-skulpt`

Хранилища объектов:
- `projects`: `{ projectId, title, files, assets, lastActiveFile, updatedAt }`
- `blobs`: `{ blobId, data }`
- `drafts`: `{ key, overlayFiles, deletedFiles, draftLastActiveFile, updatedAt }`
- `recent`: `{ key: "recent", list: [projectId...] }`

## Горячие клавиши

### Обработка в основном потоке
Горячие клавиши регистрируются в функции `init()` через слушатели событий `keydown`:

**Глобальные горячие клавиши (document level):**
- F8 или Alt+R → `runActiveFile()`
- Alt+X → `stopExecution()`
- Alt+C → `clearConsole()`
- Alt+1/2/3 → переключение фокуса между редактором, консолью и холстом

**Горячие клавиши редактора (onEditorKeydown):**
- Tab → добавление отступа
- Alt+/ → комментирование строки
- Alt+↑/↓ → перемещение строки
- Ctrl+D → дублирование строки
- Ctrl+Shift+K → удаление строки
- Ctrl+L → выделение строки

**Горячие клавиши консоли:**
- Enter (без Shift) → отправка многострочного ввода как отдельных input() вызовов
- Shift+Enter → добавление новой строки в поле ввода

### Отображение справки
Функция `showHotkeysModal()` отображает полный список горячих клавиш в модальном диалоговом окне.

Если IndexedDB недоступна, используется хранилище в оперативной памяти на базе `Map`.

## Воркер выполнения
`assets/worker.js`:
- `importScripts()` загружает Skulpt из `vendor/skulpt`.
- Stdout/stderr проксируются в основной поток.
- `input()` реализован через очередь в основном потоке.
- Каждый запуск записывает файлы и выполняет точку входа.
- Точка входа запускается как основной модуль Python.

## Конвейер Turtle
- `TURTLE_SHIM` заменяет стандартный модуль `turtle` в воркере.
- События Turtle сериализуются и отправляются в основной поток.
- Основной поток отрисовывает графику на холсте (canvas) с управлением скоростью и анимацией.
- События указателя/касания нормализуются и отправляются обратно в воркер.

## Шеринг и снимки
- При шеринге состояние проекта сериализуется в JSON и кодируется как UTF-8 байты.
- Сжатие данных:
  - Используется `CompressionStream("gzip")`, если доступно.
  - Резервный вариант — `gzipSync` из `fflate`.
- Кодирование: base64url с префиксом:
  - `g.<data>` для gzip.
  - `u.<data>` для обычного текста.
- `shareId`:
  - SHA-256 через `crypto.subtle`, если доступно.
  - Резервный вариант — хеш на основе FNV-1a.
- Снимки неизменяемы; локальные правки сохраняются в `drafts`.

## CSP и COI
- CSP (мета-тег в `index.html`) включает:
  - `script-src 'self' 'unsafe-eval'`
  - `worker-src 'self' blob:`
- `sw.js` внедряет заголовки COOP/COEP/CORP для изоляции cross-origin.

## Совместимость с браузерами
Резервные механизмы в `assets/skulpt-app.js`:
- Полифиллы для TextEncoder/TextDecoder.
- Генерация UUID без `crypto.randomUUID`.
- `CompressionStream/DecompressionStream` -> `fflate` gzip.
- `crypto.subtle digest` -> FNV-1a.
- `navigator.clipboard` -> `document.execCommand`.
- IndexedDB -> хранилище `Map` в памяти.
- Pointer events -> обработчики мыши/касаний.
- Загрузка воркера через `fetch()` -> прямой URL воркера.

Поддерживаемые браузеры:
- Chrome
- Chromium
- Safari

Неподдерживаемые браузеры:
- Firefox
- Другие движки, отличные от Chromium/Safari.

## Лимиты и защитные механизмы
- `RUN_TIMEOUT_MS`: 60 секунд.
- `MAX_OUTPUT_BYTES`: 2,000,000 байт.
- `MAX_FILES`: 30.
- `MAX_SINGLE_FILE_BYTES`: 50,000 байт.
- `MAX_TOTAL_TEXT_BYTES`: 250,000 байт.
- Этап сборки не требуется.
- Сервис-воркер можно отключить, удалив регистрацию `sw.js`.

## Известные ограничения
- **⚠️ DEPRECATED**: Загрузка файлов через UI (Assets) больше не поддерживается. Экспорт и импорт проектов работают нормально.
- Снимки не зашифрованы; они закодированы и опционально сжаты.
- Внешние сетевые запросы заблокированы политикой CSP.
